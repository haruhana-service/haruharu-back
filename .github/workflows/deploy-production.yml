name: haruharu-deploy-production
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 소스코드 체크아웃
        uses: actions/checkout@v4

      - name: JDK 21 설치
        uses: actions/setup-java@v4
        with:
          distribution: liberica
          java-version: 21

      - name: Gradle 설정 및 캐싱
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: application.yml files
        run: |
          mkdir -p ./src/main/resources
          cd ./src/main/resources
          echo "${{ secrets.APPLICATION_YML }}" > ./application.yml
          echo "${{ secrets.APPLICATION_PROD_YML }}" > ./application-prod.yml
          echo "${{ secrets.APPLICATION_LOCAL_YML }}" > ./application-local.yml
          echo "${{ secrets.APPLICATION_TEST_YML }}" > ./application-test.yml
          echo "${{ secrets.APPLICATION_S3_YML }}" > ./application-s3.yml

      - name: Firebase 서비스계정 키 파일 생성
        run: |
          mkdir -p ./src/main/resources
          cd ./src/main/resources
          echo '${{ secrets.FIREBASE_JSON }}' > ./firebase.json

      - name: Gradlew 실행 권한 부여
        run: chmod +x gradlew

      - name: Spring Boot JAR 빌드
        run: ./gradlew bootJar --parallel --build-cache

      - name: Docker Buildx 설정
        uses: docker/setup-buildx-action@v3

      - name: Docker Hub 로그인
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker 이미지 빌드 및 푸시
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/haruharu-prod:latest

      - name: monitoring 설정 파일 EC2로 복사
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_PROD_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          source: "monitoring/"
          target: "~/haruharu-prod/"
          strip_components: 0

      - name: AWS EC2에 배포
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_PROD_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          script: |
            mkdir -p ~/haruharu-prod/nginx
            cd ~/haruharu-prod

            # 환경변수 파일 생성
            cat > .env << 'EOF'
            DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            GRAFANA_ADMIN_USER=${{ secrets.GRAFANA_ADMIN_USER }}
            GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}
            EOF

            # docker-compose 파일 생성
            cat > docker-compose-prod.yml << 'EOF'
            ${{ secrets.DOCKER_COMPOSE_PROD_YML }}
            EOF

            # nginx 설정 파일 생성
            cat > ./nginx/prod.conf << 'EOF'
            ${{ secrets.NGINX_PROD_CONF }}
            EOF

            # 1. app 컨테이너만 중지 (인프라 컨테이너는 유지)
            docker-compose -f docker-compose-prod.yml stop app || true

            # 2. 디스크 공간 확보 - 사용하지 않는 이미지 정리
            docker image prune -a -f || true

            # 3. 오래된 haruharu-prod 이미지 삭제 (latest 제외)
            docker images "${{ secrets.DOCKER_USERNAME }}/haruharu-prod" --format "{{.ID}} {{.Tag}}" | \
            grep -v "latest" | \
            awk '{print $1}' | \
            xargs -r docker rmi -f || true

            # 4. 빌드 캐시 및 dangling 볼륨 정리
            docker builder prune -f || true
            docker volume prune -f || true

            # 5. 디스크 공간 확인
            df -h / | grep -v Filesystem

            # 6. 새 Docker 이미지 가져오기
            docker pull ${{ secrets.DOCKER_USERNAME }}/haruharu-prod:latest

            # 7. 인프라 컨테이너 확인 및 시작 (Nginx, Prometheus, Grafana)
            docker-compose -f docker-compose-prod.yml up -d nginx prometheus grafana

            # 8. app 컨테이너만 재배포 (Zero-downtime deployment)
            docker-compose -f docker-compose-prod.yml up -d --no-deps --force-recreate app

            # 9. 최종 정리
            docker image prune -f || true

            # 10. 배포 완료 확인
            docker-compose -f docker-compose-prod.yml ps
