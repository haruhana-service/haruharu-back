name: haruharu-deploy-staging
on:
  push:
    branches:
      - Setting/#49

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: JDK 21 ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: liberica
          java-version: 21

      - name: Gradle ì„¤ì • ë° ìºì‹±
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: application.yml files ë° firebase.json ìƒì„±
        run: |
          mkdir -p ./src/main/resources
          cd ./src/main/resources
          echo "${{ secrets.APPLICATION_YML }}" > ./application.yml
          echo "${{ secrets.APPLICATION_STAGING_YML }}" > ./application-staging.yml
          echo "${{ secrets.APPLICATION_S3_YML }}" > ./application-s3.yml
          echo "${{ secrets.APPLICATION_AI_YML }}" > ./application-ai.yml
          echo "${{ secrets.FIREBASE_JSON }}" > ./firebase.json

      - name: Gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: Spring Boot JAR ë¹Œë“œ
        run: ./gradlew bootJar --parallel --build-cache --console=plain

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/haruharu-staging:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: AWS EC2ì— ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          script: |
            mkdir -p ~/haruharu-staging/nginx
            cd ~/haruharu-staging
            
            # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            echo 'DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}' > .env
            echo 'DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}' >> .env
            echo 'DB_USER=${{ secrets.DB_USER }}' >> .env
            echo 'DB_PASSWORD=${{ secrets.DB_PASSWORD }}' >> .env
            
            # docker-compose íŒŒì¼ ìƒì„± (GitHub Secretsì—ì„œ ê°€ì ¸ì˜´)
            echo '${{ secrets.DOCKER_COMPOSE_STAGING_YML }}' > docker-compose-staging.yml
            
            # nginx ì„¤ì • íŒŒì¼ ìƒì„± (GitHub Secretsì—ì„œ ê°€ì ¸ì˜´)
            echo '${{ secrets.NGINX_STAGING_CONF }}' > nginx/staging.conf
            
            echo "ğŸ“¦ ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/haruharu-staging:latest
            
            echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
            docker-compose -f docker-compose-staging.yml down --remove-orphans || true
            
            echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
            docker-compose -f docker-compose-staging.yml up -d
            
            echo "â³ ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
            sleep 30
            
            echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker-compose -f docker-compose-staging.yml ps
            
            echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰ ì¤‘..."
            for i in {1..10}; do
              if curl -sf http://localhost/health > /dev/null 2>&1; then
                echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
                break
              else
                echo "â³ í—¬ìŠ¤ì²´í¬ ì¬ì‹œë„ ì¤‘... ($i/10)"
                sleep 5
              fi
              if [ $i -eq 10 ]; then
                echo "âš ï¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ë¡œê·¸ í™•ì¸ í•„ìš”"
                docker-compose -f docker-compose-staging.yml logs --tail 30
              fi
            done
            
            echo "ğŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            docker image prune -f
            
            docker images "${{ secrets.DOCKER_USERNAME }}/haruharu-staging" --format "{{.ID}} {{.Tag}}" | \
            grep -v "latest" | \
            awk '{print $1}' | \
            xargs -r docker rmi -f || true
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"